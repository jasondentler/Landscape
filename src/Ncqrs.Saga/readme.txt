The vast majority of this implementation is taken from JOliver's CommonDomain project:
https://github.com/joliver/CommonDomain

It's been adapted to work with nCQRS.